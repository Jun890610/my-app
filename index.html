<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>í™ì½© ê°€ì¡±ì—¬í–‰</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

<style>
  :root{
    --bg:#f5f6f8;
    --card:#fff;
    --text:#111;
    --muted:#666;
    --line:#e7e7e7;
  }
  body{
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  header{
    background:#111;
    color:#fff;
    padding:14px 14px 10px;
    text-align:center;
    font-weight:800;
    letter-spacing:-0.2px;
  }
  header .sub{
    font-weight:600;
    opacity:.85;
    font-size:12px;
    margin-top:6px;
  }

  .tabs{
    display:flex;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
    overflow:auto;
  }
  .tabs button{
    flex:1;
    min-width:90px;
    padding:12px 10px;
    border:none;
    background:none;
    font-size:14px;
    cursor:pointer;
    white-space:nowrap;
  }
  .tabs button.active{
    border-bottom:3px solid #111;
    font-weight:800;
  }

  .wrap{ padding:14px; max-width:920px; margin:0 auto; }
  .toolbar{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px 0; margin:2px 0 12px;
  }
  .edit-toggle{
    display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none;
    background:#fff; border:1px solid var(--line); border-radius:999px;
    padding:8px 12px;
  }
  .btn{
    padding:8px 12px; border-radius:10px; border:1px solid #ddd;
    background:#111; color:#fff; cursor:pointer;
  }
  .btn:disabled{ opacity:.4; cursor:not-allowed; }
  .btn-ghost{ background:#fff; color:#111; }

  .card{
    background:var(--card);
    border-radius:14px;
    padding:12px;
    margin:12px 0;
    border:1px solid #eee;
  }
  .card-header{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .time{ font-weight:900; margin-bottom:6px; }
  .title{ font-weight:800; margin-top:2px; }
  .tag{
    font-size:12px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #eee;
    color:#333;
    background:#fafafa;
    flex:0 0 auto;
  }
  .meta{
    color:var(--muted);
    font-size:13px;
    margin-top:6px;
    line-height:1.45;
  }
  .map-btn{
    display:inline-block;
    margin-top:10px;
    padding:9px 12px;
    border-radius:12px;
    background:#111;
    color:#fff;
    text-decoration:none;
    font-size:13px;
  }

  /* í¸ì§‘ í¼ */
  .edit-row{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
  .edit-row input, .edit-row textarea, .edit-row select{
    width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;
    font-size:14px;
    background:#fff;
  }
  .edit-actions{ display:flex; gap:8px; margin-top:10px; }
  .small-btn{ padding:8px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
  .small-btn.danger{ border-color:#ffb3b3; color:#b30000; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; width:100%; }
  @media (max-width:720px){ .grid2{ grid-template-columns:1fr; } }

  /* ì •ë³´ ì„¹ì…˜ */
  details{
    background:#fff;
    border:1px solid #eee;
    border-radius:14px;
    padding:10px 12px;
    margin:12px 0;
  }
  summary{
    cursor:pointer;
    font-weight:800;
    list-style:none;
  }
  summary::-webkit-details-marker{ display:none; }
  .info{
    margin-top:10px;
    color:#333;
    line-height:1.55;
    font-size:14px;
  }
  .info ul{ margin:8px 0 0 18px; }
  .pill{
    display:inline-block;
    font-size:12px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #eee;
    background:#fafafa;
    margin-left:8px;
    color:#444;
  }

/* ===== Weather UI ===== */
.modal.hidden{display:none;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999;}
.modal-card{width:min(720px,100%);background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.22);overflow:hidden;}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee;gap:12px;}
.modal-title{font-weight:800;font-size:18px;}
.modal-sub{font-size:12px;color:#666;margin-top:2px;}
.modal-body{padding:14px 16px;}
.weather-now{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px 12px;border:1px solid #eee;border-radius:14px;background:#fafafa;margin-bottom:12px;}
.weather-chip{display:inline-flex;gap:6px;align-items:center;padding:7px 10px;border-radius:999px;background:#fff;border:1px solid #e8e8e8;font-size:13px;}
.weather-list-title{font-weight:700;margin:10px 0 8px;}
.weather-list{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:8px;}
@media (min-width:640px){.weather-list{grid-template-columns:repeat(2,minmax(0,1fr));}}
.weather-day{border:1px solid #eee;border-radius:14px;padding:10px 12px;background:#fff;display:flex;flex-direction:column;gap:6px;}
.weather-day .d{font-weight:800;}
.weather-note{font-size:12px;color:#666;margin-top:10px;}
.day-weather-banner{margin:10px 0 14px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.day-weather-banner .label{font-weight:800;}

</style>
</head>

<body>
<header>
  ğŸ‡­ğŸ‡° í™ì½© ê°€ì¡±ì—¬í–‰ ì›¹ì•±
  <div class="sub">2/15â€“2/17 Â· ë¶€ë¶€+ì•„ì´ Â· ìœ ëª¨ì°¨/íœ´ì‹ ë™ì„ </div>
</header>

<div class="tabs" id="tabs"></div>

<div class="wrap">
  <!-- âœ… í¸ì§‘ ëª¨ë“œ íˆ´ë°” -->
  <div id="toolbar" class="toolbar">
    <label class="edit-toggle">
      <input type="checkbox" id="editModeToggle" />
      <span>ìŠ¤ì¼€ì¤„ í¸ì§‘ ëª¨ë“œ</span>
    </label>

    <button id="addItemBtn" class="btn" disabled>+ ì¼ì • ì¶”ê°€</button>
    <button id="resetBtn" class="btn btn-ghost" disabled>ì´ˆê¸°í™”</button>

    <button id="weatherBtn" class="btn btn-ghost">ë‚ ì”¨</button>

    <button id="exportBtn" class="btn btn-ghost">ë‚´ë³´ë‚´ê¸°</button>
    <label class="btn btn-ghost" for="importFile">ê°€ì ¸ì˜¤ê¸°</label>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>

  <!-- âœ… ì½˜í…ì¸  -->
  <div id="contentRoot"></div>
</div>

<script>
/** =========================
 *  0) ë°ì´í„°(ì´ˆê¸°ê°’)
 *  ========================= */
const DEFAULT_DATA = {
  "2/15": [
    {
      id: crypto.randomUUID(),
      time: "13:30â€“14:30",
      title: "í™ì½© ë„ì°© Â· ì…êµ­ Â· ìˆ˜í•˜ë¬¼ ìˆ˜ë ¹",
      tag: "ë„ì°©",
      transport: "none",
      from: "",
      to: "",
      notes: "eSIM ì¼œê¸°/ë°ì´í„° í™•ì¸ Â· ê³µí•­ ATM ì†Œì•¡ ì¸ì¶œ(HKD) Â· ì˜¥í† í¼ìŠ¤ ì¤€ë¹„"
    },
    {
      id: crypto.randomUUID(),
      time: "14:30â€“15:30",
      title: "ê³µí•­ â†’ ë¦¬ì¸ ì¹¼íŠ¼ í™ì½©(ICC) ì´ë™",
      tag: "ì´ë™",
      transport: "driving",
      from: "Hong Kong International Airport",
      to: "The Ritz-Carlton, Hong Kong",
      notes: "ì•„ì´ ì»¨ë””ì…˜/ì§ ê³ ë ¤í•´ íƒì‹œ ì¶”ì²œ Â· ì²´í¬ì¸ ì „ ì§ ë³´ê´€ ê°€ëŠ¥"
    },
    {
      id: crypto.randomUUID(),
      time: "15:30â€“16:45",
      title: "í˜¸í…” íœ´ì‹/ì•„ì´ ë‚®ì ",
      tag: "ë‚®ì ",
      transport: "none",
      from: "",
      to: "",
      notes: "ì €ë… ì¼ì • ëŒ€ë¹„ ì²´ë ¥ íšŒë³µ(ì¤‘ìš”)"
    },
    {
      id: crypto.randomUUID(),
      time: "17:00â€“18:00",
      title: "Makâ€™s Noodle (ì™„íƒ•ë©´/ì£½ë¥˜ Â· ë¶€ë‹´ ì ê²Œ)",
      tag: "ì‹ì‚¬",
      transport: "walking",
      from: "The Ritz-Carlton, Hong Kong",
      to: "Mak's Noodle, Tsim Sha Tsui",
      notes: "ë„ë³´ ì´ë™ Â· ê²°ì œ: ì¹´ë“œ/í˜„ê¸ˆ"
    },
    {
      id: crypto.randomUUID(),
      time: "18:15â€“19:00",
      title: "Avenue of Stars í•´ë³€ ì‚°ì±… (ìœ ëª¨ì°¨ OK)",
      tag: "ì‚°ì±…",
      transport: "walking",
      from: "Mak's Noodle, Tsim Sha Tsui",
      to: "Avenue of Stars, Tsim Sha Tsui",
      notes: "ë°”ëŒ/ê¸°ì˜¨ ëŒ€ë¹„ ê²‰ì˜·"
    },
    {
      id: crypto.randomUUID(),
      time: "19:00â€“19:30",
      title: "Star Ferry (ì§§ê³  ì¬ë¯¸ìˆëŠ” ì•¼ê²½ ì²´í—˜)",
      tag: "í˜ë¦¬",
      transport: "walking",
      from: "Star Ferry Pier, Tsim Sha Tsui",
      to: "Star Ferry Pier, Central",
      notes: "ê²°ì œ: ì˜¥í† í¼ìŠ¤/í˜„ê¸ˆ Â· ì•„ì´ê°€ ì¢‹ì•„í•¨"
    },
    {
      id: crypto.randomUUID(),
      time: "19:45~",
      title: "í˜¸í…” ë³µê·€ & íœ´ì‹ (ë‚´ì¼ ë””ì¦ˆë‹ˆ ëŒ€ë¹„)",
      tag: "íœ´ì‹",
      transport: "none",
      from: "",
      to: "",
      notes: "ê°€ëŠ¥í•˜ë©´ ì¡°ê¸° ì·¨ì¹¨"
    }
  ],

  "2/16": [
    {
      id: crypto.randomUUID(),
      time: "08:30â€“09:15",
      title: "ë¦¬ì¸ ì¹¼íŠ¼ â†’ ë””ì¦ˆë‹ˆëœë“œ í˜¸í…”(ë¡¯ì§€) ì´ë™",
      tag: "ì´ë™",
      transport: "driving",
      from: "The Ritz-Carlton, Hong Kong",
      to: "Hong Kong Disneyland Hotel",
      notes: "íƒì‹œ ì¶”ì²œ(ì•„ì´+ì§) Â· ì²´í¬ì¸ ì „ ì§ ë³´ê´€"
    },
    {
      id: crypto.randomUUID(),
      time: "09:30â€“11:30",
      title: "ë””ì¦ˆë‹ˆ ì˜¤ì „ ê³¨ë“ íƒ€ì„ (ëŒ€ê¸° ì§§ì„ ë•Œ)",
      tag: "ì–´íŠ¸ë™ì…˜",
      transport: "walking",
      from: "Hong Kong Disneyland Hotel",
      to: "Hong Kong Disneyland Park",
      notes: "ì¶”ì²œ: it's a small world â†’ Pooh â†’ Dumbo(ìƒí™© ë´ì„œ) Â· ìºìŠ¬ ì‚¬ì§„"
    },
    {
      id: crypto.randomUUID(),
      time: "12:00â€“12:40",
      title: "ì ì‹¬ (Main Street/ì‹¤ë‚´ ë ˆìŠ¤í† ë‘)",
      tag: "ì‹ì‚¬",
      transport: "none",
      from: "",
      to: "",
      notes: "ì•„ì´ ì»¨ë””ì…˜ ë³´ê³  ì‹¤ë‚´ ì„ í˜¸"
    },
    {
      id: crypto.randomUUID(),
      time: "13:00â€“15:00",
      title: "í˜¸í…” ë‚®ì /íœ´ì‹ (ì €ë… í¼ë ˆì´ë“œ ì²´ë ¥ í™•ë³´)",
      tag: "ë‚®ì ",
      transport: "walking",
      from: "Hong Kong Disneyland Park",
      to: "Hong Kong Disneyland Hotel",
      notes: "ìœ ëª¨ì°¨/ë„ë³´ ë˜ëŠ” ì…”í‹€"
    },
    {
      id: crypto.randomUUID(),
      time: "15:15â€“16:00",
      title: "Lion King ì‡¼(ì‹¤ë‚´) / ë˜ëŠ” ìºë¦­í„° ë¯¸íŒ…",
      tag: "ì‡¼",
      transport: "walking",
      from: "Hong Kong Disneyland Hotel",
      to: "Hong Kong Disneyland Park",
      notes: "ë‚ ì”¨/ì•„ì´ ì»¨ë””ì…˜ì— ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ"
    },
    {
      id: crypto.randomUUID(),
      time: "16:45â€“17:20",
      title: "Jungle River Cruise / ì‚°ì±…/ê°„ì‹",
      tag: "ì–´íŠ¸ë™ì…˜",
      transport: "none",
      from: "",
      to: "",
      notes: "ëŒ€ê¸° ê¸¸ë©´ í¼ë ˆì´ë“œ ìë¦¬ ì„ ì ìœ¼ë¡œ ì „í™˜"
    },
    {
      id: crypto.randomUUID(),
      time: "18:30â€“19:30",
      title: "ì €ë… (Explorerâ€™s Club Restaurant ë“±)",
      tag: "ì‹ì‚¬",
      transport: "none",
      from: "",
      to: "",
      notes: "ì•¼ê°„ì‡¼/ë¶ˆê½ƒ ì „ ê°„ë‹¨íˆ"
    },
    {
      id: crypto.randomUUID(),
      time: "20:20â€“20:40",
      title: "íŒŒí¬ â†’ í˜¸í…” ë³µê·€ (ë„ë³´/ì…”í‹€)",
      tag: "ì´ë™",
      transport: "walking",
      from: "Hong Kong Disneyland Park",
      to: "Hong Kong Disneyland Hotel",
      notes: "ëë‚˜ë©´ ë°”ë¡œ ìˆ™ì†Œë¡œ"
    }
  ],

  "2/17": [
    {
      id: crypto.randomUUID(),
      time: "09:00â€“09:30",
      title: "ë¦¬ì¡°íŠ¸ ì‚°ì±…/ê¸°ë…ì‚¬ì§„",
      tag: "ì‚°ì±…",
      transport: "none",
      from: "",
      to: "",
      notes: "ì²´í¬ì•„ì›ƒ ì¤€ë¹„"
    },
    {
      id: crypto.randomUUID(),
      time: "10:00â€“10:40",
      title: "ë””ì¦ˆë‹ˆëœë“œ í˜¸í…” â†’ ê³µí•­ ì´ë™",
      tag: "ì´ë™",
      transport: "driving",
      from: "Hong Kong Disneyland Hotel",
      to: "Hong Kong International Airport",
      notes: "ì‹œê°„ ì—¬ìœ  ìˆê²Œ ì¶œë°œ"
    },
    {
      id: crypto.randomUUID(),
      time: "14:40",
      title: "âœˆï¸ ì¶œêµ­",
      tag: "ì¶œêµ­",
      transport: "none",
      from: "",
      to: "",
      notes: "ë©´ì„¸/ì‹ì‚¬/ì•„ì´ íœ´ì‹ ê³ ë ¤"
    }
  ],

  "â˜” ìš°ì²œ": [
    {
      id: crypto.randomUUID(),
      time: "10:00â€“10:40",
      title: "Lion King ì‡¼(ì‹¤ë‚´)",
      tag: "ì‹¤ë‚´",
      transport: "none",
      from: "",
      to: "",
      notes: "ìš°ì²œ ì‹œ ìš°ì„  ì¶”ì²œ"
    },
    {
      id: crypto.randomUUID(),
      time: "10:50â€“11:20",
      title: "it's a small world (ì‹¤ë‚´/ëŒ€ê¸° ì§§ìŒ)",
      tag: "ì‹¤ë‚´",
      transport: "none",
      from: "",
      to: "",
      notes: "ìœ ëª¨ì°¨ OK"
    },
    {
      id: crypto.randomUUID(),
      time: "11:30â€“12:00",
      title: "Animation Academy / ì‹¤ë‚´ ì²´í—˜",
      tag: "ì‹¤ë‚´",
      transport: "none",
      from: "",
      to: "",
      notes: "ì•„ì´ ì»¨ë””ì…˜ ë”°ë¼ ì§§ê²Œ"
    },
    {
      id: crypto.randomUUID(),
      time: "15:15â€“16:00",
      title: "ì‹¤ë‚´ ìºë¦­í„° ë¯¸íŒ…",
      tag: "ì‹¤ë‚´",
      transport: "none",
      from: "",
      to: "",
      notes: "ë¹„ ì˜¬ ë•Œ ë§Œì¡±ë„ ë†’ìŒ"
    }
  ]
};

/** =========================
 *  1) ì €ì¥/ë¡œë“œ
 *  ========================= */
const STORAGE_KEY = "hk_trip_schedule_v2";
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return structuredClone(DEFAULT_DATA);
  try{ return JSON.parse(raw); }catch{ return structuredClone(DEFAULT_DATA); }
}
function saveData(d){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
}

/** =========================
 *  2) êµ¬ê¸€ë§µ ë§í¬ ìƒì„±
 *  ========================= */
function mapsUrl(item){
  if(!item.from || !item.to) return "";
  const from = encodeURIComponent(item.from);
  const to = encodeURIComponent(item.to);
  if(item.transport === "walking") return `https://www.google.com/maps/dir/${from}/${to}/?travelmode=walking`;
  if(item.transport === "driving") return `https://www.google.com/maps/dir/${from}/${to}/?travelmode=driving`;
  if(item.transport === "transit") return `https://www.google.com/maps/dir/${from}/${to}/?travelmode=transit`;
  return `https://www.google.com/maps/dir/${from}/${to}/`;
}
function labelTransport(t){
  if(t==="walking") return "ë„ë³´";
  if(t==="transit") return "ëŒ€ì¤‘êµí†µ";
  if(t==="driving") return "íƒì‹œ/ì°¨ëŸ‰";
  return "ì—†ìŒ";
}

/** =========================
 *  3) ìƒíƒœ
 *  ========================= */
let data = loadData();
saveData(data); // ìµœì´ˆ ì €ì¥
let activeTab = "2/15";
let editMode = false;

const tabsEl = document.getElementById("tabs");
const contentRoot = document.getElementById("contentRoot");

const editToggle = document.getElementById("editModeToggle");
const addBtn = document.getElementById("addItemBtn");
const resetBtn = document.getElementById("resetBtn");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");

/** =========================
 *  4) ë Œë”ë§
 *  ========================= */
const TAB_ORDER = ["2/15","2/16","2/17","â˜” ìš°ì²œ","ğŸ“Œ í•„ìˆ˜ì •ë³´"];

function renderTabs(){
  tabsEl.innerHTML = TAB_ORDER.map(k=>{
    return `<button class="${k===activeTab?'active':''}" data-tab="${k}">${k}</button>`;
  }).join("");

  tabsEl.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      activeTab = btn.dataset.tab;
      render();
initWeatherUI();
    });
  });
}

function render(){
  renderTabs();

  const isInfo = (activeTab === "ğŸ“Œ í•„ìˆ˜ì •ë³´");
  document.getElementById("toolbar").style.display = isInfo ? "none" : "flex";

  if(isInfo){
    contentRoot.innerHTML = renderInfo();
    return;
  }

  const list = data[activeTab] || [];
  contentRoot.innerHTML = list.map(item=>renderCard(item)).join("");

  // í¸ì§‘ ì´ë²¤íŠ¸
  if(editMode){
    contentRoot.querySelectorAll("[data-action]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const action = el.dataset.action;
        const id = el.dataset.id;
        if(action==="save") return onSave(id);
        if(action==="delete") return onDelete(id);
      });
    });
  }
}

function renderCard(item){
  const url = mapsUrl(item);
  const showMap = url && item.transport !== "none";
  const moveLine = (item.transport !== "none")
    ? `êµí†µ: ${labelTransport(item.transport)}${(item.from && item.to) ? ` Â· ${escapeHtml(item.from)} â†’ ${escapeHtml(item.to)}` : ""}`
    : "";

  return `
    <div class="card" data-id="${item.id}">
      <div class="card-header">
        <div style="min-width:0">
          <div class="time">${escapeHtml(item.time || "")}</div>
          <div class="title">${escapeHtml(item.title || "")}</div>
          <div class="meta">
            ${moveLine ? `<div>${moveLine}</div>` : ""}
            ${item.notes ? `<div style="margin-top:6px">${escapeHtml(item.notes)}</div>` : ""}
          </div>
          ${showMap ? `<a class="map-btn" href="${url}" target="_blank" rel="noopener">ì§€ë„ ì—´ê¸°</a>` : ""}
        </div>
        <div class="tag">${escapeHtml(item.tag || "")}</div>
      </div>

      ${editMode ? renderEditForm(item) : ""}
    </div>
  `;
}

function renderEditForm(item){
  return `
    <div class="edit-row">
      <div class="grid2">
        <input placeholder="ì‹œê°„ (ì˜ˆ: 09:00â€“11:30)" value="${escapeAttr(item.time||"")}" data-field="time" data-id="${item.id}">
        <input placeholder="íƒœê·¸ (ì˜ˆ: ì´ë™/ì‹ì‚¬/ì‡¼)" value="${escapeAttr(item.tag||"")}" data-field="tag" data-id="${item.id}">
      </div>

      <input placeholder="ì œëª©" value="${escapeAttr(item.title||"")}" data-field="title" data-id="${item.id}">

      <div class="grid2">
        <select data-field="transport" data-id="${item.id}">
          <option value="none" ${item.transport==="none"?"selected":""}>ì´ë™ ì—†ìŒ</option>
          <option value="walking" ${item.transport==="walking"?"selected":""}>ë„ë³´</option>
          <option value="transit" ${item.transport==="transit"?"selected":""}>ëŒ€ì¤‘êµí†µ(MTR)</option>
          <option value="driving" ${item.transport==="driving"?"selected":""}>íƒì‹œ/ì°¨ëŸ‰</option>
        </select>
        <input placeholder="ì¶œë°œì§€ (ì˜ˆ: Hong Kong Disneyland Hotel)" value="${escapeAttr(item.from||"")}" data-field="from" data-id="${item.id}">
      </div>

      <input placeholder="ë„ì°©ì§€ (ì˜ˆ: Hong Kong Disneyland Park)" value="${escapeAttr(item.to||"")}" data-field="to" data-id="${item.id}">

      <textarea rows="3" placeholder="ë©”ëª¨/ë””í…Œì¼" data-field="notes" data-id="${item.id}">${escapeHtml(item.notes||"")}</textarea>

      <div class="edit-actions">
        <button class="small-btn" data-action="save" data-id="${item.id}">ì €ì¥</button>
        <button class="small-btn danger" data-action="delete" data-id="${item.id}">ì‚­ì œ</button>
      </div>
    </div>
  `;
}

/** =========================
 *  5) í¸ì§‘ ë¡œì§
 *  ========================= */
function onDelete(id){
  data[activeTab] = (data[activeTab]||[]).filter(x=>x.id!==id);
  saveData(data);
  render();
}
function onSave(id){
  const fields = contentRoot.querySelectorAll(`[data-id="${id}"][data-field]`);
  const patch = {};
  fields.forEach(el=>{
    const key = el.dataset.field;
    patch[key] = el.value;
  });

  data[activeTab] = (data[activeTab]||[]).map(item=>{
    if(item.id !== id) return item;
    return {...item, ...patch};
  });

  saveData(data);
  render();
}

/** =========================
 *  6) íˆ´ë°” ì´ë²¤íŠ¸
 *  ========================= */
editToggle.addEventListener("change", ()=>{
  editMode = editToggle.checked;
  addBtn.disabled = !editMode;
  resetBtn.disabled = !editMode;
  render();
});

addBtn.addEventListener("click", ()=>{
  const newItem = {
    id: crypto.randomUUID(),
    time: "",
    title: "",
    tag: "",
    transport: "none",
    from: "",
    to: "",
    notes: ""
  };
  data[activeTab] = [newItem, ...(data[activeTab]||[])];
  saveData(data);
  render();
});

resetBtn.addEventListener("click", ()=>{
  if(!confirm("ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? (ì €ì¥ëœ í¸ì§‘ ë‚´ìš©ì´ ì‚¬ë¼ì ¸ìš”)")) return;
  data = structuredClone(DEFAULT_DATA);
  saveData(data);
  render();
});

exportBtn.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "hk-trip-schedule.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

importFile.addEventListener("change", async ()=>{
  const file = importFile.files?.[0];
  if(!file) return;
  const text = await file.text();
  try{
    const obj = JSON.parse(text);
    data = obj;
    saveData(data);
    render();
    alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
  }catch{
    alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. ë‚´ë³´ë‚´ê¸° íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.");
  }finally{
    importFile.value = "";
  }
});

/** =========================
 *  7) í•„ìˆ˜ì •ë³´ ë Œë”
 *  ========================= */
function renderInfo(){
  return `
    <details open>
      <summary>ğŸ’³ ëˆ/ê²°ì œ/ì˜¥í† í¼ìŠ¤ <span class="pill">ì—¬í–‰ ì¤‘ ìì£¼ ë´„</span></summary>
      <div class="info">
        <ul>
          <li><b>ì˜¥í† í¼ìŠ¤ ì¹´ë“œ</b>: êµí†µ/MTR/í˜ë¦¬/í¸ì˜ì ì—ì„œ ë§¤ìš° ìœ ìš©</li>
          <li><b>ì¹´ë“œ ê²°ì œ</b>: ëŒ€ë¶€ë¶„ ê°€ëŠ¥(í˜¸í…”/ëŒ€í˜• ì‹ë‹¹/í¸ì˜ì )</li>
          <li><b>í˜„ê¸ˆ</b>: ì†Œì•¡ë§Œ ì¤€ë¹„(ë¡œì»¬/ê°„ì‹/ì†Œê·œëª¨ ìƒì )</li>
          <li><b>íŒ</b>: íƒì‹œ/ì‹ë‹¹ì€ ìƒí™© ë”°ë¼ ì†Œì•¡ íŒ(ê°•ì œëŠ” ì•„ë‹˜)</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>ğŸ’± í™˜ì „/í˜„ê¸ˆ ì‚¬ìš© íŒ</summary>
      <div class="info">
        <ul>
          <li>ê³µí•­ ë„ì°© í›„ <b>ATMë¡œ ì†Œì•¡ HKD</b> ë¨¼ì € í™•ë³´(ê°€ì¥ í¸í•¨)</li>
          <li>í™˜ì „ì€ <b>í•„ìš”í•  ë•Œë§Œ</b> ì†Œì•¡ ë‹¨ìœ„ë¡œ (í˜„ê¸ˆ ê³¼ë‹¤ ë³´ìœ  X)</li>
          <li>ì•„ì´ ë™í–‰ì´ë¼ <b>ì´ë™/ê°„ì‹</b> ìš©ë„ë¡œ í˜„ê¸ˆ 300~600HKD ì •ë„ë©´ ì¶©ë¶„í•œ í¸</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>ğŸ“± eSIM ì‚¬ìš© ë§¤ë‰´ì–¼</summary>
      <div class="info">
        <ol style="margin:8px 0 0 18px;">
          <li>í•œêµ­ì—ì„œ QRë¡œ eSIM ì„¤ì¹˜</li>
          <li>í™ì½© ë„ì°© í›„ <b>ì…€ë£°ëŸ¬ ë°ì´í„°</b>ë¥¼ eSIMìœ¼ë¡œ ì„¤ì •</li>
          <li><b>ë°ì´í„° ë¡œë° ON</b>(ìƒí’ˆì— ë”°ë¼ í•„ìš”) Â· ìŒì„±ì€ ì¹´í†¡/ë¼ì¸ ì‚¬ìš©</li>
          <li>ì•ˆ ë˜ë©´: ë¹„í–‰ê¸°ëª¨ë“œ ON/OFF â†’ ì¬ë¶€íŒ… â†’ APN í™•ì¸ ìˆœ</li>
        </ol>
      </div>
    </details>

    <details>
      <summary>ğŸ§¸ ì•„ì´ ë™ë°˜ ì²´í¬</summary>
      <div class="info">
        <ul>
          <li>ë””ì¦ˆë‹ˆ ë‚ ì€ <b>ë‚®ì (13~15ì‹œ)</b>ì´ í•µì‹¬</li>
          <li>ìœ ëª¨ì°¨: ì‹¤ì™¸ ì´ë™ ë§ìœ¼ë©´ í•„ìˆ˜, ì‹¤ë‚´ ì‡¼ë¡œ ë¦¬ë“¬ ì¡°ì ˆ</li>
          <li>ë¹„/ì¶”ìœ„ ëŒ€ë¹„: ì–‡ì€ ê²‰ì˜· + ìš°ë¹„/ë°©ìˆ˜ ì»¤ë²„</li>
        </ul>
      </div>
    </details>

    <div class="card" style="margin-top:16px">
      <div class="title">âœ… ì‚¬ìš© íŒ</div>
      <div class="meta" style="margin-top:8px">
        â€¢ ìƒë‹¨ íƒ­ì—ì„œ ë‚ ì§œ ì´ë™<br>
        â€¢ <b>ìŠ¤ì¼€ì¤„ í¸ì§‘ ëª¨ë“œ</b> ì¼œë©´ ì¼ì • ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥<br>
        â€¢ ì´ë™ ì¼ì •ì€ ì¶œë°œì§€/ë„ì°©ì§€ë¥¼ ì ìœ¼ë©´ <b>ì§€ë„ ì—´ê¸°</b> ë²„íŠ¼ì´ ìë™ìœ¼ë¡œ ìƒê¹€
      </div>
    </div>
  `;
}

/** =========================
 *  8) XSS ì•ˆì „ ì¶œë ¥
 *  ========================= */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}
function escapeAttr(str){
  return escapeHtml(str).replace(/\n/g," ");
}

/** ìµœì´ˆ ë Œë” */
render();

/** =========================
 *  ğŸŒ¤ï¸ ë‚ ì”¨ (Openâ€‘Meteo, API Key ë¶ˆí•„ìš”)
 *  ========================= */
const WEATHER = {
  lat: 22.3193,
  lon: 114.1694,
  tz: "Asia/Hong_Kong",
  // íƒ­(2/15,2/16,2/17)ì„ ì‹¤ì œ ë‚ ì§œ(ì˜¬í•´ or ë‚´ë…„)ë¡œ ë§¤í•‘
  resolveTripDates() {
    const now = new Date();
    let year = now.getFullYear();
    // 2ì›” 15ì¼ì´ ì´ë¯¸ ì§€ë‚˜ê°”ìœ¼ë©´ ë‚´ë…„ìœ¼ë¡œ
    const base = new Date(year, 1, 15);
    if (base.getTime() < (now.getTime() - 24*60*60*1000)) year += 1;
    const map = {};
    ["2/15","2/16","2/17"].forEach((md, i) => {
      const d = new Date(year, 1, 15 + i);
      const iso = d.toISOString().slice(0,10);
      map[md] = iso;
    });
    return {year, map};
  },
  wmoToText(code){
    const m = {
      0:"ë§‘ìŒ",1:"ëŒ€ì²´ë¡œ ë§‘ìŒ",2:"êµ¬ë¦„ ì¡°ê¸ˆ",3:"íë¦¼",
      45:"ì•ˆê°œ",48:"ì„œë¦¬ ì•ˆê°œ",
      51:"ì´ìŠ¬ë¹„(ì•½)",53:"ì´ìŠ¬ë¹„(ì¤‘)",55:"ì´ìŠ¬ë¹„(ê°•)",
      61:"ë¹„(ì•½)",63:"ë¹„(ì¤‘)",65:"ë¹„(ê°•)",
      71:"ëˆˆ(ì•½)",73:"ëˆˆ(ì¤‘)",75:"ëˆˆ(ê°•)",
      80:"ì†Œë‚˜ê¸°(ì•½)",81:"ì†Œë‚˜ê¸°(ì¤‘)",82:"ì†Œë‚˜ê¸°(ê°•)",
      95:"ë‡Œìš°",96:"ë‡Œìš°(ìš°ë°•)",99:"ê°•í•œ ë‡Œìš°(ìš°ë°•)"
    };
    return m[code] ?? `ë‚ ì”¨ì½”ë“œ ${code}`;
  },
  async fetch(){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${this.lat}&longitude=${this.lon}`
      + `&current=temperature_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m`
      + `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weather_code`
      + `&timezone=${encodeURIComponent(this.tz)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("ë‚ ì”¨ API ì‹¤íŒ¨");
    return res.json();
  }
};

let weatherCache = null; window.weatherCache = weatherCache;

function formatKDate(iso){
  const [y,m,d]=iso.split("-").map(Number);
  return `${m}/${d}`;
}

function renderWeatherModal(api){
  const nowEl = document.getElementById("weatherNow");
  const listEl = document.getElementById("weatherList");
  if(!nowEl || !listEl) return;

  const c = api.current;
  const chips = [
    `í˜„ì¬ ${c.temperature_2m}Â°C`,
    `ì²´ê° ${c.apparent_temperature}Â°C`,
    `ê°•ìˆ˜ ${c.precipitation}mm`,
    `ë°”ëŒ ${c.wind_speed_10m}m/s`,
    WEATHER.wmoToText(c.weather_code)
  ].map(t=>`<span class="weather-chip">${escapeHtml(t)}</span>`).join("");
  nowEl.innerHTML = chips;

  const t = api.daily.time;
  const max = api.daily.temperature_2m_max;
  const min = api.daily.temperature_2m_min;
  const pop = api.daily.precipitation_probability_max;
  const code = api.daily.weather_code;

  let html = "";
  for(let i=0;i<t.length;i++){
    html += `
      <div class="weather-day">
        <div class="d">${formatKDate(t[i])} <span style="font-weight:600;color:#666">(${t[i]})</span></div>
        <div>${escapeHtml(WEATHER.wmoToText(code[i]))}</div>
        <div>ìµœê³  ${max[i]}Â° / ìµœì € ${min[i]}Â°</div>
        <div>ê°•ìˆ˜í™•ë¥  ${pop[i]}%</div>
      </div>`;
  }
  listEl.innerHTML = html;
}

function getDayForecast(api, iso){
  const t = api.daily.time;
  const i = t.indexOf(iso);
  if(i === -1) return null;
  return {
    iso,
    text: WEATHER.wmoToText(api.daily.weather_code[i]),
    max: api.daily.temperature_2m_max[i],
    min: api.daily.temperature_2m_min[i],
    pop: api.daily.precipitation_probability_max[i]
  };
}

// ê° ë‚ ì§œ íƒ­ ìƒë‹¨ì— "ë‚ ì”¨ ë°°ë„ˆ"ë¥¼ ë²„íŠ¼/ì¹© í˜•íƒœë¡œ í‘œì‹œ
function renderDayWeatherBanner(api){
  const {map} = WEATHER.resolveTripDates();
  const iso = map[activeTab];
  const f = iso ? getDayForecast(api, iso) : null;

  // ê¸°ì¡´ ë°°ë„ˆ ì œê±°
  const old = document.getElementById("dayWeatherBanner");
  if(old) old.remove();

  if(!f) return;

  const banner = document.createElement("div");
  banner.id = "dayWeatherBanner";
  banner.className = "day-weather-banner";
  banner.innerHTML = `
    <span class="label">ì˜¤ëŠ˜(${activeTab}) ë‚ ì”¨</span>
    <span class="weather-chip">${escapeHtml(f.text)}</span>
    <span class="weather-chip">ìµœê³  ${f.max}Â° / ìµœì € ${f.min}Â°</span>
    <span class="weather-chip">ê°•ìˆ˜í™•ë¥  ${f.pop}%</span>
    <button id="openWeatherFromBanner" class="btn btn-ghost">ìì„¸íˆ</button>
  `;

  // contentRoot ë§¨ ìœ„ì— ì‚½ì…
  if(contentRoot) contentRoot.prepend(banner);

  const btn = document.getElementById("openWeatherFromBanner");
  if(btn){
    btn.addEventListener("click", ()=> openWeatherModal());
  }
}

async function ensureWeather(){
  if(weatherCache) return weatherCache;
  weatherCache = await WEATHER.fetch(); window.weatherCache = weatherCache;
  return weatherCache;
}

function openWeatherModal(){
  const modal = document.getElementById("weatherModal");
  if(!modal) return;
  modal.classList.remove("hidden");
}

function closeWeatherModal(){
  const modal = document.getElementById("weatherModal");
  if(!modal) return;
  modal.classList.add("hidden");
}

async function initWeatherUI(){
  const btn = document.getElementById("weatherBtn");
  const closeBtn = document.getElementById("weatherClose");
  const modal = document.getElementById("weatherModal");

  if(btn){
    btn.addEventListener("click", async ()=>{
      try{
        const api = await ensureWeather();
        renderWeatherModal(api);
        renderDayWeatherBanner(api);
        openWeatherModal();
      }catch(e){
        alert("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        console.error(e);
      }
    });
  }
  if(closeBtn) closeBtn.addEventListener("click", closeWeatherModal);
  if(modal){
    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeWeatherModal();
    });
  }

  // ì²« ë¡œë”© ì‹œì—ë„ ë°°ë„ˆëŠ” ì‹œë„(ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨í•´ë„ ì•±ì€ ë™ì‘)
  try{
    const api = await ensureWeather();
    renderDayWeatherBanner(api);
  }catch(e){
    console.warn("weather preload failed", e);
  }
}

</script>

<!-- ğŸŒ¤ï¸ ë‚ ì”¨ ëª¨ë‹¬ -->
<div id="weatherModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="weatherTitle">
  <div class="modal-card">
    <div class="modal-head">
      <div>
        <div id="weatherTitle" class="modal-title">í™ì½© ë‚ ì”¨</div>
        <div class="modal-sub">Openâ€‘Meteo ê¸°ë°˜ Â· 16ì¼ ì˜ˆë³´</div>
      </div>
      <button id="weatherClose" class="btn btn-ghost">ë‹«ê¸°</button>
    </div>
    <div class="modal-body">
      <div id="weatherNow" class="weather-now">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div class="weather-list-title">ë‚ ì§œë³„ ì˜ˆë³´</div>
      <div id="weatherList" class="weather-list"></div>
      <div class="weather-note">* ì˜ˆë³´ëŠ” ë°”ë€” ìˆ˜ ìˆì–´ìš”. ì¶œë°œ ì „/ë‹¹ì¼ì— ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.</div>
    </div>
  </div>
</div>

</body>
</html>
